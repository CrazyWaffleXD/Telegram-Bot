import telebot
from telebot import types
import sqlite3
from datetime import datetime

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
TOKEN = '8094895160:AAGzj1vzPOWgs502sAcqC1ZP51_Y-3arv0s'
bot = telebot.TeleBot(TOKEN)
ADMIN_IDS = [5672359649]  # –í–∞—à ID —Ç–µ–ª–µ–≥—Ä–∞–º–∞

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
conn = sqlite3.connect('tasks.db', check_same_thread=False)
cursor = conn.cursor()

# –ü—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã
PREDEFINED_DISCIPLINES = [
    "–£—á–µ–±–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –ø–æ –ü–ú.01",
    "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –ø–æ –ü–ú.01",
    "–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫ –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏",
    "–§–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞",
    "–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ —Å–µ—Ç–∏",
    "–≠–∫–∑–∞–º–µ–Ω –ø–æ –ü–ú.01",
    "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã—Ö –º–æ–¥—É–ª–µ–π",
    "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π",
    "–°–∏—Å—Ç–µ–º–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ",
    "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è"
]

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
def initialize_database():
    # –°–æ–∑–¥–∞–µ–º –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
    tables = [
        '''CREATE TABLE IF NOT EXISTS users
           (id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER UNIQUE,
            username TEXT,
            first_name TEXT,
            last_name TEXT,
            join_date TEXT)''',
            
        '''CREATE TABLE IF NOT EXISTS logs
           (id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            action TEXT,
            timestamp TEXT)''',
            
        '''CREATE TABLE IF NOT EXISTS disciplines
           (id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT UNIQUE)''',
            
        '''CREATE TABLE IF NOT EXISTS tasks
           (id INTEGER PRIMARY KEY AUTOINCREMENT,
            discipline_id INTEGER,
            name TEXT,
            description TEXT,
            deadline TEXT,
            added_by INTEGER,
            FOREIGN KEY(discipline_id) REFERENCES disciplines(id))''',
            
        '''CREATE TABLE IF NOT EXISTS solutions
           (id INTEGER PRIMARY KEY AUTOINCREMENT,
            task_id INTEGER,
            text TEXT,
            added_by INTEGER,
            FOREIGN KEY(task_id) REFERENCES tasks(id))''',
            
        '''CREATE TABLE IF NOT EXISTS photos
           (id INTEGER PRIMARY KEY AUTOINCREMENT,
            task_id INTEGER,
            file_id TEXT,
            FOREIGN KEY(task_id) REFERENCES tasks(id))'''
    ]
    
    for table in tables:
        cursor.execute(table)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã
    for discipline in PREDEFINED_DISCIPLINES:
        try:
            cursor.execute("INSERT OR IGNORE INTO disciplines (name) VALUES (?)", (discipline,))
        except:
            pass
    conn.commit()

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π
def log_action(user_id, action):
    cursor.execute("INSERT INTO logs (user_id, action, timestamp) VALUES (?, ?, ?)",
                  (user_id, action, datetime.now().strftime("%Y-%m-%d %H:%M:%S")))
    conn.commit()

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
def main_menu(user_id):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    buttons = [
        "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ", 
        "–°–ø–∏—Å–æ–∫ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω",
        "–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π"
    ]
    
    if user_id in ADMIN_IDS:
        buttons.append("–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å")
    
    markup.add(*[types.KeyboardButton(btn) for btn in buttons])
    return markup

# –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
def admin_panel(user_id):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    buttons = [
        "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏", 
        "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
        "–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
        "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è–º–∏",
        "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞–º–∏",
        "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"
    ]
    markup.add(*[types.KeyboardButton(btn) for btn in buttons])
    return markup

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@bot.message_handler(commands=['start'])
def start(message):
    user_id = message.from_user.id
    username = message.from_user.username
    first_name = message.from_user.first_name
    last_name = message.from_user.last_name
    join_date = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    cursor.execute("INSERT OR IGNORE INTO users (user_id, username, first_name, last_name, join_date) VALUES (?, ?, ?, ?, ?)",
                  (user_id, username, first_name, last_name, join_date))
    conn.commit()
    
    log_action(user_id, "–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ /start")
    bot.send_message(user_id, "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è —É—á–µ—Ç–∞ —É—á–µ–±–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π.", reply_markup=main_menu(user_id))

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
@bot.message_handler(content_types=['text'])
def handle_text(message):
    user_id = message.from_user.id
    text = message.text
    
    log_action(user_id, f"–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞: {text}")
    
    if text == "–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å" and user_id in ADMIN_IDS:
        bot.send_message(user_id, "–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å:", reply_markup=admin_panel(user_id))
    
    elif text == "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏" and user_id in ADMIN_IDS:
        view_logs(message)
    
    elif text == "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" and user_id in ADMIN_IDS:
        view_user_stats(message)
    
    elif text == "–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" and user_id in ADMIN_IDS:
        view_all_users(message)
    
    elif text == "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ":
        show_disciplines_for_selection(message)
    
    elif text == "–°–ø–∏—Å–æ–∫ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω":
        show_disciplines(message)
    
    elif text == "–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π":
        show_disciplines_for_tasks(message)
    
    elif text == "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è–º–∏" and user_id in ADMIN_IDS:
        manage_tasks(message)
    
    elif text == "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞–º–∏" and user_id in ADMIN_IDS:
        manage_disciplines(message)
    
    elif text in ["–ù–∞–∑–∞–¥", "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"]:
        handle_back(message)

# --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–¥–∞–Ω–∏—è–º–∏ ---

def show_disciplines_for_selection(message):
    user_id = message.from_user.id
    cursor.execute("SELECT id, name FROM disciplines")
    disciplines = cursor.fetchall()
    
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    buttons = [types.KeyboardButton(f"–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞: {disc[1]}") for disc in disciplines]
    buttons.append(types.KeyboardButton("–ù–∞–∑–∞–¥"))
    markup.add(*buttons)
    
    bot.send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É –¥–ª—è –∑–∞–¥–∞–Ω–∏—è:", reply_markup=markup)

@bot.message_handler(func=lambda message: message.text.startswith("–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞: "))
def process_task_discipline(message):
    user_id = message.from_user.id
    discipline_name = message.text.replace("–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞: ", "")
    
    cursor.execute("SELECT id FROM disciplines WHERE name = ?", (discipline_name,))
    result = cursor.fetchone()
    
    if not result:
        bot.send_message(user_id, "–û—à–∏–±–∫–∞: –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", reply_markup=main_menu(user_id))
        return
    
    discipline_id = result[0]
    msg = bot.send_message(user_id, "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è:", reply_markup=types.ReplyKeyboardRemove())
    bot.register_next_step_handler(msg, process_task_name, discipline_id)

def process_task_name(message, discipline_id):
    user_id = message.from_user.id
    if message.text == "–ù–∞–∑–∞–¥":
        show_disciplines_for_selection(message)
        return
    
    task_name = message.text
    msg = bot.send_message(user_id, "–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è:", reply_markup=types.ReplyKeyboardRemove())
    bot.register_next_step_handler(msg, process_task_description, discipline_id, task_name, user_id)

def process_task_description(message, discipline_id, task_name, added_by):
    user_id = message.from_user.id
    if message.text == "–ù–∞–∑–∞–¥":
        msg = bot.send_message(user_id, "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è:", reply_markup=types.ReplyKeyboardRemove())
        bot.register_next_step_handler(msg, process_task_name, discipline_id)
        return
    
    task_description = message.text
    msg = bot.send_message(user_id, "–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–î–î.–ú–ú.–ì–ì–ì–ì):", reply_markup=types.ReplyKeyboardRemove())
    bot.register_next_step_handler(msg, process_task_deadline, discipline_id, task_name, task_description, added_by)

def process_task_deadline(message, discipline_id, task_name, task_description, added_by):
    user_id = message.from_user.id
    if message.text == "–ù–∞–∑–∞–¥":
        msg = bot.send_message(user_id, "–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è:", reply_markup=types.ReplyKeyboardRemove())
        bot.register_next_step_handler(msg, process_task_description, discipline_id, task_name, added_by)
        return
    
    task_deadline = message.text
    try:
        cursor.execute("INSERT INTO tasks (discipline_id, name, description, deadline, added_by) VALUES (?, ?, ?, ?, ?)",
                      (discipline_id, task_name, task_description, task_deadline, added_by))
        conn.commit()
        
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
        markup.add("–î–∞", "–ù–µ—Ç", "–ù–∞–∑–∞–¥")
        
        msg = bot.send_message(user_id, "–•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫ –∑–∞–¥–∞–Ω–∏—é?", reply_markup=markup)
        bot.register_next_step_handler(msg, process_photo_decision, cursor.lastrowid)
    except Exception as e:
        bot.send_message(user_id, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è: {str(e)}", reply_markup=main_menu(user_id))

def process_photo_decision(message, task_id):
    user_id = message.from_user.id
    if message.text == "–ù–∞–∑–∞–¥":
        bot.send_message(user_id, "–ó–∞–¥–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –±–µ–∑ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π.", reply_markup=main_menu(user_id))
        return
    
    if message.text.lower() == "–¥–∞":
        msg = bot.send_message(user_id, "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è –∑–∞–¥–∞–Ω–∏—è:", reply_markup=types.ReplyKeyboardRemove())
        bot.register_next_step_handler(msg, process_task_photos, task_id)
    else:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
        markup.add("–î–∞", "–ù–µ—Ç", "–ù–∞–∑–∞–¥")
        
        msg = bot.send_message(user_id, "–•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ –∫ –∑–∞–¥–∞–Ω–∏—é?", reply_markup=markup)
        bot.register_next_step_handler(msg, process_solution_decision, task_id, user_id)

@bot.message_handler(content_types=['photo'])
def process_task_photos(message, task_id):
    user_id = message.from_user.id
    file_id = message.photo[-1].file_id
    cursor.execute("INSERT INTO photos (task_id, file_id) VALUES (?, ?)", (task_id, file_id))
    conn.commit()
    
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    markup.add("–ì–æ—Ç–æ–≤–æ", "–î–æ–±–∞–≤–∏—Ç—å –µ—â–µ —Ñ–æ—Ç–æ", "–ù–∞–∑–∞–¥")
    
    msg = bot.send_message(user_id, "–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ. –ß—Ç–æ –¥–∞–ª—å—à–µ?", reply_markup=markup)
    bot.register_next_step_handler(msg, process_more_photos, task_id, user_id)

def process_more_photos(message, task_id, added_by):
    user_id = message.from_user.id
    if message.text == "–ù–∞–∑–∞–¥":
        bot.send_message(user_id, "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –æ—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=main_menu(user_id))
        return
    
    if message.text == "–î–æ–±–∞–≤–∏—Ç—å –µ—â–µ —Ñ–æ—Ç–æ":
        msg = bot.send_message(user_id, "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é:", reply_markup=types.ReplyKeyboardRemove())
        bot.register_next_step_handler(msg, process_task_photos, task_id)
    else:
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
        markup.add("–î–∞", "–ù–µ—Ç", "–ù–∞–∑–∞–¥")
        
        msg = bot.send_message(user_id, "–•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ –∫ –∑–∞–¥–∞–Ω–∏—é?", reply_markup=markup)
        bot.register_next_step_handler(msg, process_solution_decision, task_id, added_by)

def process_solution_decision(message, task_id, added_by):
    user_id = message.from_user.id
    if message.text == "–ù–∞–∑–∞–¥":
        bot.send_message(user_id, "–ó–∞–¥–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –±–µ–∑ —Ä–µ—à–µ–Ω–∏—è.", reply_markup=main_menu(user_id))
        return
    
    if message.text.lower() == "–¥–∞":
        msg = bot.send_message(user_id, "–í–≤–µ–¥–∏—Ç–µ —Ä–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è:", reply_markup=types.ReplyKeyboardRemove())
        bot.register_next_step_handler(msg, process_task_solution, task_id, added_by)
    else:
        bot.send_message(user_id, "–ó–∞–¥–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!", reply_markup=main_menu(user_id))

def process_task_solution(message, task_id, added_by):
    user_id = message.from_user.id
    if message.text == "–ù–∞–∑–∞–¥":
        bot.send_message(user_id, "–ó–∞–¥–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –±–µ–∑ —Ä–µ—à–µ–Ω–∏—è.", reply_markup=main_menu(user_id))
        return
    
    solution_text = message.text
    cursor.execute("INSERT INTO solutions (task_id, text, added_by) VALUES (?, ?, ?)", (task_id, solution_text, added_by))
    conn.commit()
    bot.send_message(user_id, "–†–µ—à–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –∫ –∑–∞–¥–∞–Ω–∏—é!", reply_markup=main_menu(user_id))

# --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞–º–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤) ---

def manage_disciplines(message):
    user_id = message.from_user.id
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    buttons = ["–î–æ–±–∞–≤–∏—Ç—å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É", "–£–¥–∞–ª–∏—Ç—å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É", "–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É", "–ù–∞–∑–∞–¥"]
    markup.add(*[types.KeyboardButton(btn) for btn in buttons])
    bot.send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞–º–∏:", reply_markup=markup)

@bot.message_handler(func=lambda message: message.text == "–î–æ–±–∞–≤–∏—Ç—å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É" and message.from_user.id in ADMIN_IDS)
def add_discipline(message):
    user_id = message.from_user.id
    msg = bot.send_message(user_id, "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã:", reply_markup=types.ReplyKeyboardRemove())
    bot.register_next_step_handler(msg, process_new_discipline)

def process_new_discipline(message):
    user_id = message.from_user.id
    if message.text == "–ù–∞–∑–∞–¥":
        manage_disciplines(message)
        return
    
    discipline_name = message.text
    try:
        cursor.execute("INSERT INTO disciplines (name) VALUES (?)", (discipline_name,))
        conn.commit()
        bot.send_message(user_id, f"–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ '{discipline_name}' —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!", reply_markup=admin_panel(user_id))
    except sqlite3.IntegrityError:
        bot.send_message(user_id, f"–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ '{discipline_name}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!", reply_markup=admin_panel(user_id))

@bot.message_handler(func=lambda message: message.text == "–£–¥–∞–ª–∏—Ç—å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É" and message.from_user.id in ADMIN_IDS)
def delete_discipline_step1(message):
    user_id = message.from_user.id
    cursor.execute("SELECT id, name FROM disciplines")
    disciplines = cursor.fetchall()
    
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    buttons = [types.KeyboardButton(f"–£–¥–∞–ª–∏—Ç—å: {disc[1]}") for disc in disciplines]
    buttons.append(types.KeyboardButton("–ù–∞–∑–∞–¥"))
    markup.add(*buttons)
    
    bot.send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:", reply_markup=markup)

@bot.message_handler(func=lambda message: message.text.startswith("–£–¥–∞–ª–∏—Ç—å: ") and message.from_user.id in ADMIN_IDS)
def delete_discipline_step2(message):
    user_id = message.from_user.id
    discipline_name = message.text.replace("–£–¥–∞–ª–∏—Ç—å: ", "")
    
    try:
        cursor.execute("DELETE FROM disciplines WHERE name = ?", (discipline_name,))
        conn.commit()
        bot.send_message(user_id, f"–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ '{discipline_name}' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!", reply_markup=admin_panel(user_id))
    except Exception as e:
        bot.send_message(user_id, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: {str(e)}", reply_markup=admin_panel(user_id))

@bot.message_handler(func=lambda message: message.text == "–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É" and message.from_user.id in ADMIN_IDS)
def rename_discipline_step1(message):
    user_id = message.from_user.id
    cursor.execute("SELECT id, name FROM disciplines")
    disciplines = cursor.fetchall()
    
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    buttons = [types.KeyboardButton(f"–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å: {disc[1]}") for disc in disciplines]
    buttons.append(types.KeyboardButton("–ù–∞–∑–∞–¥"))
    markup.add(*buttons)
    
    bot.send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É –¥–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è:", reply_markup=markup)

@bot.message_handler(func=lambda message: message.text.startswith("–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å: ") and message.from_user.id in ADMIN_IDS)
def rename_discipline_step2(message):
    user_id = message.from_user.id
    old_name = message.text.replace("–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å: ", "")
    
    msg = bot.send_message(user_id, f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã '{old_name}':", reply_markup=types.ReplyKeyboardRemove())
    bot.register_next_step_handler(msg, process_rename_discipline, old_name)

def process_rename_discipline(message, old_name):
    user_id = message.from_user.id
    if message.text == "–ù–∞–∑–∞–¥":
        manage_disciplines(message)
        return
    
    new_name = message.text
    try:
        cursor.execute("UPDATE disciplines SET name = ? WHERE name = ?", (new_name, old_name))
        conn.commit()
        bot.send_message(user_id, f"–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ —Å '{old_name}' –Ω–∞ '{new_name}'!", reply_markup=admin_panel(user_id))
    except Exception as e:
        bot.send_message(user_id, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏: {str(e)}", reply_markup=admin_panel(user_id))

# --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è–º–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤) ---

def manage_tasks(message):
    user_id = message.from_user.id
    cursor.execute("SELECT id, name FROM disciplines")
    disciplines = cursor.fetchall()
    
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    buttons = [types.KeyboardButton(f"–ó–∞–¥–∞–Ω–∏—è: {disc[1]}") for disc in disciplines]
    buttons.append(types.KeyboardButton("–ù–∞–∑–∞–¥"))
    markup.add(*buttons)
    
    bot.send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è–º–∏:", reply_markup=markup)

@bot.message_handler(func=lambda message: message.text.startswith("–ó–∞–¥–∞–Ω–∏—è: ") and message.from_user.id in ADMIN_IDS)
def show_tasks_for_management(message):
    user_id = message.from_user.id
    discipline_name = message.text.replace("–ó–∞–¥–∞–Ω–∏—è: ", "")
    
    cursor.execute('''SELECT t.id, t.name 
                   FROM tasks t 
                   JOIN disciplines d ON t.discipline_id = d.id 
                   WHERE d.name = ?''', (discipline_name,))
    tasks = cursor.fetchall()
    
    if not tasks:
        bot.send_message(user_id, f"–í –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–µ '{discipline_name}' –Ω–µ—Ç –∑–∞–¥–∞–Ω–∏–π.", reply_markup=admin_panel(user_id))
        return
    
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    buttons = [types.KeyboardButton(f"–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ: {task[1]}") for task in tasks]
    buttons.append(types.KeyboardButton("–ù–∞–∑–∞–¥"))
    markup.add(*buttons)
    
    bot.send_message(user_id, f"–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –∏–∑ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã '{discipline_name}' –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:", reply_markup=markup)

@bot.message_handler(func=lambda message: message.text.startswith("–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ: ") and message.from_user.id in ADMIN_IDS)
def delete_task(message):
    user_id = message.from_user.id
    task_name = message.text.replace("–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ: ", "")
    
    try:
        cursor.execute("DELETE FROM tasks WHERE name = ?", (task_name,))
        conn.commit()
        bot.send_message(user_id, f"–ó–∞–¥–∞–Ω–∏–µ '{task_name}' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ!", reply_markup=admin_panel(user_id))
    except Exception as e:
        bot.send_message(user_id, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: {str(e)}", reply_markup=admin_panel(user_id))

# --- –ê–¥–º–∏–Ω-—Ñ—É–Ω–∫—Ü–∏–∏ ---

def view_logs(message):
    user_id = message.from_user.id
    cursor.execute("SELECT * FROM logs ORDER BY timestamp DESC LIMIT 50")
    logs = cursor.fetchall()
    
    if not logs:
        bot.send_message(user_id, "–õ–æ–≥–∏ –ø—É—Å—Ç—ã.")
        return
    
    response = "–ü–æ—Å–ª–µ–¥–Ω–∏–µ 50 –¥–µ–π—Å—Ç–≤–∏–π:\n\n"
    for log in logs:
        log_id, log_user_id, action, timestamp = log
        cursor.execute("SELECT username FROM users WHERE user_id = ?", (log_user_id,))
        user = cursor.fetchone()
        username = user[0] if user else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"
        response += f"{timestamp} - {username} ({log_user_id}): {action}\n"
    
    bot.send_message(user_id, response)

def view_user_stats(message):
    user_id = message.from_user.id
    
    cursor.execute("SELECT COUNT(*) FROM users")
    total_users = cursor.fetchone()[0]
    
    cursor.execute("SELECT user_id, COUNT(*) FROM logs GROUP BY user_id ORDER BY COUNT(*) DESC LIMIT 10")
    active_users = cursor.fetchall()
    
    response = f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:\n\n"
    response += f"üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total_users}\n\n"
    
    response += "üèÜ –°–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:\n"
    for active_user in active_users:
        user_id, count = active_user
        cursor.execute("SELECT username FROM users WHERE user_id = ?", (user_id,))
        username = cursor.fetchone()
        username = username[0] if username else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"
        response += f"- @{username}: {count} –¥–µ–π—Å—Ç–≤–∏–π\n"
    
    bot.send_message(user_id, response)

def view_all_users(message):
    user_id = message.from_user.id
    cursor.execute("SELECT user_id, username, first_name, last_name, join_date FROM users ORDER BY join_date DESC")
    users = cursor.fetchall()
    
    if not users:
        bot.send_message(user_id, "–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")
        return
    
    response = "üìã –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:\n\n"
    for user in users:
        user_id, username, first_name, last_name, join_date = user
        name = f"{first_name} {last_name}" if last_name else first_name
        response += f"üë§ {name} (@{username if username else '–Ω–µ—Ç'})\n"
        response += f"üÜî ID: {user_id}\n"
        response += f"üìÖ –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {join_date}\n\n"
    
    bot.send_message(user_id, response)

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---

def show_disciplines(message):
    user_id = message.from_user.id
    cursor.execute("SELECT name FROM disciplines")
    disciplines = cursor.fetchall()
    
    if not disciplines:
        bot.send_message(user_id, "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∏—Å—Ü–∏–ø–ª–∏–Ω.", reply_markup=main_menu(user_id))
        return
    
    response = "–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã:\n"
    for i, disc in enumerate(disciplines, 1):
        response += f"{i}. {disc[0]}\n"
    
    bot.send_message(user_id, response, reply_markup=main_menu(user_id))

def show_disciplines_for_tasks(message):
    user_id = message.from_user.id
    cursor.execute("SELECT id, name FROM disciplines")
    disciplines = cursor.fetchall()
    
    if not disciplines:
        bot.send_message(user_id, "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∏—Å—Ü–∏–ø–ª–∏–Ω.", reply_markup=main_menu(user_id))
        return
    
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    buttons = [types.KeyboardButton(f"–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è: {disc[1]}") for disc in disciplines]
    buttons.append(types.KeyboardButton("–ù–∞–∑–∞–¥"))
    markup.add(*buttons)
    
    bot.send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–¥–∞–Ω–∏–π:", reply_markup=markup)

@bot.message_handler(func=lambda message: message.text.startswith("–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è: "))
def show_tasks_for_discipline(message):
    user_id = message.from_user.id
    discipline_name = message.text.replace("–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è: ", "")
    
    cursor.execute('''SELECT t.name, t.description, t.deadline 
                   FROM tasks t 
                   JOIN disciplines d ON t.discipline_id = d.id 
                   WHERE d.name = ?''', (discipline_name,))
    tasks = cursor.fetchall()
    
    if not tasks:
        bot.send_message(user_id, f"–í –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–µ '{discipline_name}' –Ω–µ—Ç –∑–∞–¥–∞–Ω–∏–π.", reply_markup=main_menu(user_id))
        return
    
    response = f"–ó–∞–¥–∞–Ω–∏—è –ø–æ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–µ '{discipline_name}':\n\n"
    for i, task in enumerate(tasks, 1):
        response += f"{i}. {task[0]}\n–û–ø–∏—Å–∞–Ω–∏–µ: {task[1]}\n–°—Ä–æ–∫: {task[2]}\n\n"
    
    bot.send_message(user_id, response, reply_markup=main_menu(user_id))

def handle_back(message):
    user_id = message.from_user.id
    if user_id in ADMIN_IDS and message.text == "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é":
        bot.send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=main_menu(user_id))
    else:
        bot.send_message(user_id, "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=main_menu(user_id))

if __name__ == '__main__':
    initialize_database()
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    bot.polling()